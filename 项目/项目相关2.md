# mymuduo

- Question：
  1. **项目中的问题？**
     - chatserver使用muduo时候发现，用户发送消息后，好友只能接受到部分消息
     - TcpConnection中send函数，判断loop不是在当前线程中，调用runinloop进行消息发送，并不是立即发送，send函数传的buf是引用，导致缓冲区中的内容已经失效，实际发送时候内容已经没有了
  2. **为什么用LT模式？**
     - 不会丢失数据或消息
     - 每次读数据只需要一次系统调用，保证了多个连接的公平性，不会因为数据量过大而影响
  3. **如果内核写缓冲区充足，epoll的LT模式会反复的触发可写事件，怎么解决？**
     - 先不关注可写事件，有数据直接往socket里写，如果没写完，把没写完的数据放到应用层缓冲区，然后关注可写事件
  4. **如果都不要IO多路复用（select、poll、epoll），套接字会怎么样？**
     - 阻塞和非阻塞
  5. **多线程+阻塞可以实现吗？多线程的开销来自哪里？**
     - 创建销毁线程
     - 线程同步、互斥
  6. **线程池可以实现吗？线程池的开销来自哪里？**
     - 线程池：管理一个线程队列、一个任务队列，每次取一个任务分配给线程去做
     - 开销：锁mutex+条件变量/锁+信号量，mutex保存任务的互斥性，条件变量保持任务的同步性
     - [线程池](https://www.cnblogs.com/lzpong/p/6397997.html)

# ChatServer

- Question：
  1. **项目中的知识点？**
     - chatservice是个单例模式
       - static局部变量只初始化一次，每次得到的都是service的地址
     - 信号量的使用（线程间共享变量）：
       - 主线程作为发送线程，子线程作为接受线程
       - 客户端登录时，主线程启动子线程；
       - 客户端用户注销时，主线程使用semaphore信号量进行通知
  2. **项目中的问题1（C++11多线程、锁）？**
     - 登录后要记录用户连接信息
     - 登录时候的多线程问题，可能造成多线程安全问题
     - 多个客户端同时修改一个账户的登录情况
     - 采用加锁的方式进行修正
     - C++11中mutex，但是手动加锁上锁麻烦
     - lock_guard</mutex>在离开作用域时候自动释放锁
  3. **项目中的问题2（数据库表设计问题）？**
     - Friend表中的两个人为联合主键，两个键不同时重复即可
     - offlinemessage表中的主键问题，之前设置userid为主键，导致离线消息只能存储一条，InnoDB自动设置主键，解决问题
  4. **项目中的问题3（）？**
     - 
  5. **数据传输的安全问题？**
     - 混合加密：对称加密（两边用同一个私钥、AES）+非对称加密（公钥+私钥，公钥加密只能私钥解密、RSA）
     - 内容用对称加密，对称加密的密钥用非对称加密
     - 服务端公钥加密对称加密的私钥，客户端用私钥解密对称加密的私钥，从而进行验证和数据读操作
     - 对称加密：快速，安全性低，两边公用一个密钥
     - 非对称加密：安全性高，加密复杂
  6. **如何保证消息按序显示？**
     - 使用时间戳，在客户端显示进行信息的排序；但是消息错乱顺序多的时候不好进行排序
     - 使用seq序列号，0号消息未到，1号消息已到，1号消息在客户端等待，等到0号消息到来后一起进行显示
     - 用seq序列号，还可以进行撤回功能拓展，否则不容易找到对应撤回消息
     - seq越界问题，用unsigned long long超过最大值之后变为0，两边共用一个seq，不太需要担心越界问题
  7. **Server如何感知客户端状态？**
     - 心跳机制，每隔1s给每个客户端的heartbeatcnt+1，客户端每秒发送一个心跳包cnt-1，cnt超过阈值之后掉线
     - TCP keep-alive：有三个参数，心跳检测时间、超时后多少时间再发探测包、最多探测次数；TCP在传输层，不在应用层，传输层属于系统内核，无法和应用层业务进行通信
  8. **如何保证消息的可靠传输？**
     - send函数检测的仅仅是从用户空间缓冲区拷贝到内核空间，成功拷贝就返回已拷贝字节数，不管消息是否发送
     - 用seq检测客户端已经收到了哪些报文，哪些没有收到
     - TCP的重传机制为什么不行，TCP在传输层属于系统内核，不向应用层提供接口，应用层无法感知消息是否真正发送成功
  9. **历史消息存储问题？**
     - 本地消息存储：按QQ号进行分文件存储，时间等等，SQLite（嵌入式数据库）
     - 云消息存储：用MySQL进行存储，半年或者一年前的消息单独进行存储，因为访问几率比较小
  10. **除了用Redis使用发布订阅还能使用什么？**
     - MQ消息队列，kafka、zeromq、rabbitmq
  11. **为什么要用Redis作为跨服务器通信的组件，为什么各个server不能相互直接进行通信？**
      - 如果有六个服务器用Nginx配置，查询某个用户是否在线时需要和其他五个服务器进行通信，编程复杂，服务器压力大
      - Redis作为消息队列，不在本机的推送到消息队列中，分发给订阅该频道的服务器
  12. **为什么要用Nginx?**
      - 单台服务器受限于硬件资源，单台服务器不能满足并发需求量，需要部署多台服务器，但是客户端不知道具体去连接哪一台服务器；此时需要一台负载均衡器，指导客户端连接服务器。
      - 1.9版本之前只支持http协议web服务器的负载均衡；1.9版本之后支持tcp长连接负载均衡（-with-stream参数激活）
      - Apache不支持热部署（升级的时候不需要重新启动应用）、Lighttpd有内存泄露的问题
      - 一致性哈希算法：哈希环上的数据顺时针寻找对应的节点，单个节点失效后瞬时针找下一个算法
  13. **为什么要用Redis作为消息队列？**
      - 问题：五六台主机想要通信需要两两连接，编程复杂，服务器还要拿出来资源进行检测，消耗大
      - kafka、rabbitmq、zeromq
      - Redis作者把disque功能移植到了Redis中
      - 生产者消费者模型、发布/订阅模式。
      - 缺点：消费者下线、Redis宕机、消息堆积缓冲区溢出
      - [Redis做消息队列](https://www.zhihu.com/question/20795043)